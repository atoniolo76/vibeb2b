<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vibesB2B</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800&display=swap" rel="stylesheet">
    <link href="./output.css" rel="stylesheet">
</head>
<body class="min-h-screen bg-white text-gray-900 font-sans">
    <!-- Custom Title Bar -->
    <div class="fixed top-0 left-0 right-0 h-8 bg-white border-b border-gray-200 flex items-center justify-start px-4 z-50" style="-webkit-app-region: drag;">
        <div class="flex items-center space-x-1" style="-webkit-app-region: no-drag;">
            <button onclick="closeWindow()" class="w-3 h-3 rounded-full bg-red-400 hover:bg-red-500 transition-colors"></button>
            <button onclick="minimizeWindow()" class="w-3 h-3 rounded-full bg-yellow-400 hover:bg-yellow-500 transition-colors"></button>
            <button onclick="maximizeWindow()" class="w-3 h-3 rounded-full bg-green-400 hover:bg-green-500 transition-colors"></button>
        </div>
    </div>

    <div class="pt-10">

    <!-- Main Interface -->
    <div id="main-interface" class="container mx-auto pt-20 max-w-6xl">
        <div class="text-center mb-8 my-auto">
            <div class="flex items-center justify-center mb-3">
                <img src="../Beach_Ball_PNG_Clip_Art_Image-2055932628.png" alt="Beach Ball" class="w-8 h-8 object-contain mr-2">
                <h1 class="text-3xl font-light text-gray-900">vibesB2B</h1>
            </div>
            <p class="text-gray-600">Server for the AI Powered Business Assistant</p>
        </div>


        <!-- Webhook Setup -->
        <div id="webhook-setup" class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6" style="display: none;">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-light text-gray-900">Webhook Configuration</h3>
                <div class="flex items-center text-sm">
                    <div class="w-3 h-3 rounded-full mr-2 bg-yellow-500" id="webhook-status"></div>
                    <span id="webhook-text">Setting up relay...</span>
                </div>
            </div>
            <div class="space-y-4">
                <!-- Relay URL Section -->
                <div id="relay-url-section">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Webhook Relay URL</label>
                    <div class="flex space-x-2">
                        <input
                            type="text"
                            id="relay-url"
                            readonly
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 font-mono text-sm"
                            placeholder="Waiting for relay URL..."
                        />
                        <button onclick="copyRelayUrl()" class="px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors duration-200">
                            Copy
                        </button>
                    </div>
                </div>

                <!-- Success Instructions -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-blue-800">Next Steps</h4>
                            <p class="text-sm text-blue-700 mt-1">
                                Create a webhook in Recall.ai using the relay URL above. Set the event type to <strong>recording.done</strong> to receive notifications when recordings are completed.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recording Control -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-light text-gray-900">Recording Control</h3>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center text-sm">
                        <div class="w-3 h-3 rounded-full mr-2 bg-gray-500" id="recall-status"></div>
                        <span id="recall-text">Not listening</span>
                    </div>
                </div>
            </div>
            <div class="flex">
                <button id="recall-toggle-btn" onclick="toggleRecallListening()" class="bg-blue-600 hover:bg-blue-700 text-black font-medium py-3 px-6 rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md">
                    Start Listening
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-3">
                Start listening for meeting recordings. When a meeting is detected, it will automatically record and upload to Recall.ai.
            </p>
        </div>

        <!-- Activity Log -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6" id="log-area">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-light text-gray-900">Activity Log</h3>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center text-sm text-gray-500">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Live Updates
                    </div>
                    <button onclick="toggleActivityLog()" class="flex items-center text-sm text-gray-600 hover:text-gray-800 transition-colors" id="log-toggle-btn">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="log-toggle-icon">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                        </svg>
                        <span id="log-toggle-text">Hide</span>
                    </button>
                </div>
            </div>
            <div class="max-h-80 overflow-y-auto bg-gray-50 rounded-lg p-4 font-mono text-sm space-y-2" id="log-content">
                <div class="log-entry text-gray-700">Application started...</div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // IPC communication with main process
        const { ipcRenderer } = require('electron');

        // Status update functions
        function updateStatus(elementId, status, text) {
            const indicator = document.querySelector(`#${elementId} .w-3`);
            const textElement = document.getElementById(`${elementId.split('-')[0]}-text`);

            // Only update if elements exist (UI elements may be removed)
            if (indicator && textElement) {
                // Update status indicator color
                indicator.className = 'w-3 h-3 rounded-full mr-2 ' +
                    (status === 'running' ? 'bg-green-500' :
                     status === 'error' ? 'bg-red-500' : 'bg-gray-500');
                textElement.textContent = text;
            }
        }

        function log(message) {
            const logContent = document.getElementById('log-content');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry text-gray-700 text-xs';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }

        // Button handlers
        async function startMastra() {
            log('Starting Mastra server...');
            try {
                const result = await ipcRenderer.invoke('start-mastra');
                if (result.success) {
                    log('Mastra server started successfully');
                    checkHealth();
                } else {
                    log('Failed to start Mastra: ' + result.message);
                }
            } catch (error) {
                log('Error starting Mastra: ' + error.message);
            }
        }

        async function stopMastra() {
            log('Stopping Mastra server...');
            try {
                const result = await ipcRenderer.invoke('stop-mastra');
                if (result.success) {
                    log('Mastra server stopped successfully');
                    checkHealth();
                } else {
                    log('Failed to stop Mastra: ' + result.message);
                }
            } catch (error) {
                log('Error stopping Mastra: ' + error.message);
            }
        }


        async function checkHealth() {
            log('Checking server health...');
            try {
                const health = await ipcRenderer.invoke('check-health');

                // Log server status instead of updating UI
                if (health.mastra.status === 'running') {
                    log('✅ Mastra Server is running on port 4111');
                } else {
                    log('❌ Mastra Server is not running');
                }

                // Update recall status indicator and button
                const recallStatus = health.processes?.recall;
                if (recallStatus) {
                    updateRecallStatus(recallStatus.isRunning);
                    updateToggleButton(recallStatus.isRunning);
                }

                log('Health check completed');
            } catch (error) {
                log('Error checking health: ' + error.message);
            }
        }

        // Recall listening toggle function
        async function toggleRecallListening() {
            try {
                const result = await ipcRenderer.invoke('toggle-recall-listening');
                if (result.success) {
                    if (result.action === 'started') {
                        log('✅ Recall listening started successfully');
                        updateRecallStatus(true);
                        updateToggleButton(true);
                    } else {
                        log('✅ Recall listening stopped successfully');
                        updateRecallStatus(false);
                        updateToggleButton(false);
                    }
                    checkHealth(); // Refresh status
                } else {
                    log('❌ Failed to toggle recall listening: ' + result.message);
                }
            } catch (error) {
                log('❌ Error toggling recall listening: ' + error.message);
            }
        }

        function updateToggleButton(isRunning) {
            const button = document.getElementById('recall-toggle-btn');
            if (button) {
                if (isRunning) {
                    button.textContent = 'Stop Listening';
                    button.className = 'bg-red-600 hover:bg-red-700 text-black font-medium py-3 px-6 rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md';
                } else {
                    button.textContent = 'Start Listening';
                    button.className = 'bg-blue-600 hover:bg-blue-700 text-black font-medium py-3 px-6 rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md';
                }
            }
        }

        // Activity Log toggle function
        function toggleActivityLog() {
            const logContent = document.getElementById('log-content');
            const toggleIcon = document.getElementById('log-toggle-icon');
            const toggleText = document.getElementById('log-toggle-text');

            if (logContent.style.display === 'none') {
                // Show log
                logContent.style.display = 'block';
                toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>';
                toggleText.textContent = 'Hide';
                log('Activity log shown');
            } else {
                // Hide log
                logContent.style.display = 'none';
                toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
                toggleText.textContent = 'Show';
                log('Activity log hidden');
            }
        }

        function updateRecallStatus(isRunning) {
            const statusIndicator = document.getElementById('recall-status');
            const statusText = document.getElementById('recall-text');

            if (statusIndicator && statusText) {
                if (isRunning) {
                    statusIndicator.className = 'w-3 h-3 rounded-full mr-2 bg-green-500';
                    statusText.textContent = 'Listening';
                    statusText.className = 'text-sm text-green-600';
                } else {
                    statusIndicator.className = 'w-3 h-3 rounded-full mr-2 bg-gray-500';
                    statusText.textContent = 'Not listening';
                    statusText.className = 'text-sm text-gray-500';
                }
            }
        }


        // Listen for log messages from main process
        ipcRenderer.on('log-message', (event, message) => {
            log(message);
        });

        // Listen for recall process stopped event
        ipcRenderer.on('recall-process-stopped', () => {
            updateRecallStatus(false);
            updateToggleButton(false);
        });

        // Listen for svix relay ready event
        ipcRenderer.on('svix-relay-ready', (event, relayUrl) => {
            document.getElementById('relay-url').value = relayUrl;
            document.getElementById('webhook-status').className = 'w-3 h-3 rounded-full mr-2 bg-green-500';
            document.getElementById('webhook-text').textContent = 'Relay active';

            document.getElementById('webhook-setup').style.display = 'block';
            log('Webhook relay is ready! Copy the URL above and create a webhook in Recall.ai');
        });

        // Listen for interface control messages
        ipcRenderer.on('show-main-interface', () => {
            // Main interface is already visible
            log('Main interface ready');
            checkHealth();
        });

        // Copy relay URL function
        function copyRelayUrl() {
            const relayInput = document.getElementById('relay-url');
            relayInput.select();
            relayInput.setSelectionRange(0, 99999); // For mobile devices

            navigator.clipboard.writeText(relayInput.value).then(() => {
                log('Webhook relay URL copied to clipboard!');
                // Show temporary success feedback
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.className = 'px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.className = 'px-4 py-3 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors duration-200';
                }, 2000);
            }).catch(err => {
                log('Failed to copy URL: ' + err);
            });
        }


        // Window control functions
        function minimizeWindow() {
            ipcRenderer.invoke('minimize-window');
        }

        function maximizeWindow() {
            ipcRenderer.invoke('maximize-window');
        }

        function closeWindow() {
            ipcRenderer.invoke('close-window');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('VibeB2B interface loaded');
            checkHealth(); // Initial health check

            // Auto-refresh status every 30 seconds
            setInterval(() => {
                checkHealth();
            }, 30000);
        });

    </script>
</body>
</html>
